import fetch from 'node-fetch';
//const {fetch} = require('node-fetch')
//const {MongoClient} = require('mongodb');
import {MongoClient} from 'mongodb';
const apikey = "9bb9485e113f7f8e07520d9f65878e19";
var states = ["Amravati","Port Blair","Itanagar","Patna","Raipur","New Delhi","Panji","Gandhinagar","Dispur","Chandigarh","Shimla","Ranchi","Bengaluru","Thiruvananthapuram","Leh","Kavaratti","Bhopal","Mumbai","Imphal","Shillong","Aizwal","Kohima","Bhubaneswar","Pondicherry","Chandigarh","Jaipur","Gangtok","Chennai","Hyderabad","Agartala","Lucknow","Kolkata"]

async function main(){
	const uri = 'mongodb+srv://rishav83:ogiVMdcnM4Y82kdQ@mausam.cxbamxl.mongodb.net/?retryWrites=true&w=majority';
	const client = new MongoClient(uri);

	try{
		// await client.connect();
		 for(var i = 0;i<states.length;i++){
         	console.log(states[i]);
        	await fetchLocationValues(states[i]);
        // 	const {name,speed,description} = city();
        // 	await createListing(client,
	    //     {
	    //     	city_name : name,
	    //     	speed :speed,
	    //     	description:description
	    //     },name);
    	 }

		// await listDatabases(client);
	}
	catch(e){
		console.error(e);
	}
	finally{
		await client.close();
	}
}

main().catch(console.error); //call the main function

// async function listDatabases(client){		//to list my databases
// 	dataBasesList = await client.db().admin().listDatabases();
// 	console.log("Databases:");
// 	dataBasesList.databases.forEach(db => console.log(` - ${db.name}`));
// }

async function createListing(client,newlisting,name){
	const result = await client.db("Cities").collection(name).insertOne(newlisting);
	console.log(`New listing created with the following id: ${result.insertedId}`);
}

async function fetchLocationValues(location){
		const data = await fetch("http://api.openweathermap.org/geo/1.0/direct?q="
			+location
			+"&limit=1&appid="
			+apikey
			)
		const response = await data.json();
		//console.log(response);
		const {lat,lon} = response[0];
		console.log(lat ,lon);
		city(lat,lon)

}

async function city(lat,lon){
	const data = await fetch("https://api.openweathermap.org/data/2.5/weather?lat="
				+lat
				+"&lon="
				+lon
				+"&appid="
				+apikey
				+"&units=metric");
	const response  = await data.json();
		const {name} = response;
		const {speed} = response.wind;
		const {description} = response.weather[0];
		console.log(name,speed,description);
		return name,speed,description;

		try{
			await client.connect();
			await createListing(client,
		    {
		    	city_name : name,
		    	speed :speed,
		    	description:description
		        
		    },name);
		}
		catch(e){
			console.error(e);
		}
		finally{
			await client.close();
		}
}
